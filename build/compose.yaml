version: "3.8"
services:
    graphql:
      build:
        dockerfile: ../app/Dockerfile
        context: ../app/.
      restart: unless-stopped
      deploy:
        replicas: 1
      ports:
        - "8081:8081"
      depends_on:
        - db
        - mongo
      volumes:
        - ../app:/app

    db:
      image: postgres:latest
      container_name: full_db_postgres
      environment:
        - POSTGRES_USER=${DB_USER}  
        - POSTGRES_PASSWORD=${DB_PASS}
        - POSTGRES_DB=${DB_NAME}
      ports:
        - '5432:5432'
      volumes:
        - pg_data:/var/lib/postgresql/data

    mongo:
      image: mongo:latest
      depends_on:
        - db
      restart: always
      ports:
        - 27017:27017
      environment:
        MONGO_INITDB_ROOT_USERNAME: spuser
        MONGO_INITDB_ROOT_PASSWORD: secret
        MONGO_INITDB_DATABASE: graphql
        MONGO_USER: spuser
        MONGO_DB: graphql
        MONGO_PASSWORD: secret
      volumes:
        - ./mongo:/docker-entrypoint-initdb.d      
        - ./mongo/data:/data/db:rw
volumes:
  pg_data:     
# Networks to be created to facilitate communication between containers
